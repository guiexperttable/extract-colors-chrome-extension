

const hexTailwind = {
  "#f44336": "red-500",
  "#ffebee": "red-50",
  "#ffcdd2": "red-100",
  "#ef9a9a": "red-200",
  "#e57373": "red-300",
  "#ef5350": "red-400",
  "#e53935": "red-600",
  "#d32f2f": "red-700",
  "#c62828": "red-800",
  "#b71c1c": "red-900",
  "#ff8a80": "red-100-accent",
  "#ff5252": "red-200-accent",
  "#ff1744": "red-400-accent",
  "#d50000": "red-700-accent",
  "#e91e63": "pink-500",
  "#fce4ec": "pink-50",
  "#f8bbd0": "pink-100",
  "#f48fb1": "pink-200",
  "#f06292": "pink-300",
  "#ec407a": "pink-400",
  "#d81b60": "pink-600",
  "#c2185b": "pink-700",
  "#ad1457": "pink-800",
  "#880e4f": "pink-900",
  "#ff80ab": "pink-100-accent",
  "#ff4081": "pink-200-accent",
  "#f50057": "pink-400-accent",
  "#c51162": "pink-700-accent",
  "#9c27b0": "purple-500",
  "#f3e5f5": "purple-50",
  "#e1bee7": "purple-100",
  "#ce93d8": "purple-200",
  "#ba68c8": "purple-300",
  "#ab47bc": "purple-400",
  "#8e24aa": "purple-600",
  "#7b1fa2": "purple-700",
  "#6a1b9a": "purple-800",
  "#4a148c": "purple-900",
  "#ea80fc": "purple-100-accent",
  "#e040fb": "purple-200-accent",
  "#d500f9": "purple-400-accent",
  "#aa00ff": "purple-700-accent",
  "#673ab7": "deep-purple-500",
  "#ede7f6": "deep-purple-50",
  "#d1c4e9": "deep-purple-100",
  "#b39ddb": "deep-purple-200",
  "#9575cd": "deep-purple-300",
  "#7e57c2": "deep-purple-400",
  "#5e35b1": "deep-purple-600",
  "#512da8": "deep-purple-700",
  "#4527a0": "deep-purple-800",
  "#311b92": "deep-purple-900",
  "#b388ff": "deep-purple-100-accent",
  "#7c4dff": "deep-purple-200-accent",
  "#651fff": "deep-purple-400-accent",
  "#6200ea": "deep-purple-700-accent",
  "#3f51b5": "indigo-500",
  "#e8eaf6": "indigo-50",
  "#c5cae9": "indigo-100",
  "#9fa8da": "indigo-200",
  "#7986cb": "indigo-300",
  "#5c6bc0": "indigo-400",
  "#3949ab": "indigo-600",
  "#303f9f": "indigo-700",
  "#283593": "indigo-800",
  "#1a237e": "indigo-900",
  "#8c9eff": "indigo-100-accent",
  "#536dfe": "indigo-200-accent",
  "#3d5afe": "indigo-400-accent",
  "#304ffe": "indigo-700-accent",
  "#2196f3": "blue-500",
  "#e3f2fd": "blue-50",
  "#bbdefb": "blue-100",
  "#90caf9": "blue-200",
  "#64b5f6": "blue-300",
  "#42a5f5": "blue-400",
  "#1e88e5": "blue-600",
  "#1976d2": "blue-700",
  "#1565c0": "blue-800",
  "#0d47a1": "blue-900",
  "#82b1ff": "blue-100-accent",
  "#448aff": "blue-200-accent",
  "#2979ff": "blue-400-accent",
  "#2962ff": "blue-700-accent",
  "#03a9f4": "light-blue-500",
  "#e1f5fe": "light-blue-50",
  "#b3e5fc": "light-blue-100",
  "#81d4fa": "light-blue-200",
  "#4fc3f7": "light-blue-300",
  "#29b6f6": "light-blue-400",
  "#039be5": "light-blue-600",
  "#0288d1": "light-blue-700",
  "#0277bd": "light-blue-800",
  "#01579b": "light-blue-900",
  "#80d8ff": "light-blue-100-accent",
  "#40c4ff": "light-blue-200-accent",
  "#00b0ff": "light-blue-400-accent",
  "#0091ea": "light-blue-700-accent",
  "#00bcd4": "cyan-500",
  "#e0f7fa": "cyan-50",
  "#b2ebf2": "cyan-100",
  "#80deea": "cyan-200",
  "#4dd0e1": "cyan-300",
  "#26c6da": "cyan-400",
  "#00acc1": "cyan-600",
  "#0097a7": "cyan-700",
  "#00838f": "cyan-800",
  "#006064": "cyan-900",
  "#84ffff": "cyan-100-accent",
  "#18ffff": "cyan-200-accent",
  "#00e5ff": "cyan-400-accent",
  "#00b8d4": "cyan-700-accent",
  "#009688": "teal-500",
  "#e0f2f1": "teal-50",
  "#b2dfdb": "teal-100",
  "#80cbc4": "teal-200",
  "#4db6ac": "teal-300",
  "#26a69a": "teal-400",
  "#00897b": "teal-600",
  "#00796b": "teal-700",
  "#00695c": "teal-800",
  "#004d40": "teal-900",
  "#a7ffeb": "teal-100-accent",
  "#64ffda": "teal-200-accent",
  "#1de9b6": "teal-400-accent",
  "#00bfa5": "teal-700-accent",
  "#4caf50": "green-500",
  "#e8f5e9": "green-50",
  "#c8e6c9": "green-100",
  "#a5d6a7": "green-200",
  "#81c784": "green-300",
  "#66bb6a": "green-400",
  "#43a047": "green-600",
  "#388e3c": "green-700",
  "#2e7d32": "green-800",
  "#1b5e20": "green-900",
  "#b9f6ca": "green-100-accent",
  "#69f0ae": "green-200-accent",
  "#00e676": "green-400-accent",
  "#00c853": "green-700-accent",
  "#8bc34a": "light-green-500",
  "#f1f8e9": "light-green-50",
  "#dcedc8": "light-green-100",
  "#c5e1a5": "light-green-200",
  "#aed581": "light-green-300",
  "#9ccc65": "light-green-400",
  "#7cb342": "light-green-600",
  "#689f38": "light-green-700",
  "#558b2f": "light-green-800",
  "#33691e": "light-green-900",
  "#ccff90": "light-green-100-accent",
  "#b2ff59": "light-green-200-accent",
  "#76ff03": "light-green-400-accent",
  "#64dd17": "light-green-700-accent",
  "#cddc39": "lime-500",
  "#f9fbe7": "lime-50",
  "#f0f4c3": "lime-100",
  "#e6ee9c": "lime-200",
  "#dce775": "lime-300",
  "#d4e157": "lime-400",
  "#c0ca33": "lime-600",
  "#afb42b": "lime-700",
  "#9e9d24": "lime-800",
  "#827717": "lime-900",
  "#f4ff81": "lime-100-accent",
  "#eeff41": "lime-200-accent",
  "#c6ff00": "lime-400-accent",
  "#aeea00": "lime-700-accent",
  "#ffeb3b": "yellow-500",
  "#fffde7": "yellow-50",
  "#fff9c4": "yellow-100",
  "#fff59d": "yellow-200",
  "#fff176": "yellow-300",
  "#ffee58": "yellow-400",
  "#fdd835": "yellow-600",
  "#fbc02d": "yellow-700",
  "#f9a825": "yellow-800",
  "#f57f17": "yellow-900",
  "#ffff8d": "yellow-100-accent",
  "#ffff00": "yellow-200-accent",
  "#ffea00": "yellow-400-accent",
  "#ffd600": "yellow-700-accent",
  "#ffc107": "amber-500",
  "#fff8e1": "amber-50",
  "#ffecb3": "amber-100",
  "#ffe082": "amber-200",
  "#ffd54f": "amber-300",
  "#ffca28": "amber-400",
  "#ffb300": "amber-600",
  "#ffa000": "amber-700",
  "#ff8f00": "amber-800",
  "#ff6f00": "amber-900",
  "#ffe57f": "amber-100-accent",
  "#ffd740": "amber-200-accent",
  "#ffc400": "amber-400-accent",
  "#ffab00": "amber-700-accent",
  "#ff9800": "orange-500",
  "#fff3e0": "orange-50",
  "#ffe0b2": "orange-100",
  "#ffcc80": "orange-200",
  "#ffb74d": "orange-300",
  "#ffa726": "orange-400",
  "#fb8c00": "orange-600",
  "#f57c00": "orange-700",
  "#ef6c00": "orange-800",
  "#e65100": "orange-900",
  "#ffd180": "orange-100-accent",
  "#ffab40": "orange-200-accent",
  "#ff9100": "orange-400-accent",
  "#ff6d00": "orange-700-accent",
  "#ff5722": "deep-orange-500",
  "#fbe9e7": "deep-orange-50",
  "#ffccbc": "deep-orange-100",
  "#ffab91": "deep-orange-200",
  "#ff8a65": "deep-orange-300",
  "#ff7043": "deep-orange-400",
  "#f4511e": "deep-orange-600",
  "#e64a19": "deep-orange-700",
  "#d84315": "deep-orange-800",
  "#bf360c": "deep-orange-900",
  "#ff9e80": "deep-orange-100-accent",
  "#ff6e40": "deep-orange-200-accent",
  "#ff3d00": "deep-orange-400-accent",
  "#dd2c00": "deep-orange-700-accent",
  "#795548": "brown-500",
  "#efebe9": "brown-50",
  "#d7ccc8": "brown-100",
  "#bcaaa4": "brown-200",
  "#a1887f": "brown-300",
  "#8d6e63": "brown-400",
  "#6d4c41": "brown-600",
  "#5d4037": "brown-700",
  "#4e342e": "brown-800",
  "#3e2723": "brown-900",
  "#9e9e9e": "grey-500",
  "#fafafa": "grey-50",
  "#f5f5f5": "grey-100",
  "#eeeeee": "grey-200",
  "#e0e0e0": "grey-300",
  "#bdbdbd": "grey-400",
  "#757575": "grey-600",
  "#616161": "grey-700",
  "#424242": "grey-800",
  "#212121": "grey-900",
  "#607d8b": "blue-grey-500",
  "#eceff1": "blue-grey-50",
  "#cfd8dc": "blue-grey-100",
  "#b0bec5": "blue-grey-200",
  "#90a4ae": "blue-grey-300",
  "#78909c": "blue-grey-400",
  "#546e7a": "blue-grey-600",
  "#455a64": "blue-grey-700",
  "#37474f": "blue-grey-800",
  "#263238": "blue-grey-900"
};

/**
 * Converts a hex code to the corresponding Tailwind utility class.
 *
 * @param {string} hex - The hex code to convert.
 * @returns {string} - The Tailwind utility class corresponding to the hex code.
 */
function hexToTailwind(hex){
  return hexTailwind[hex];
}


/**
 * Scrapes the colors from the currently active tab using Chrome extension APIs.
 *
 * @returns {Promise<Array>} - A promise that resolves to an array of colors scraped from the tab.
 */
async function scrapColors() {
  try {
    return chrome.scripting.executeScript({
      target: {tabId: currentTab.id},
      func: getColors

    }).then((res) => {
      return res[0].result;
    });
  } catch (err) {
    console.error(`failed to execute script: ${err}`);
  }
}


/**
 * Retrieves all CSS custom properties that have color values from the loaded style sheets.
 *
 * @returns {Array<Object>} An array of objects containing the rule selector, property name, and property value.
 */
const getColors = () => {


  /**
   * Represents an array of HTML elements.
   * @type {Array<string>}
   */
  const elements = ['html', 'body', 'p','div','a','button','input','span','h1','h2','h3','li','ul','table','th','tr','td'];

  /**
   * Regular expression for validating color values.
   *
   * The colorRegex variable represents a regular expression that matches various color formats,
   * including hexadecimal colors (#RRGGBB or #RGB), RGB, HSL, HWB, LAB, LCH, Oklab, Oklch color models,
   * and their respective alpha channel variants (e.g., rgba(), hsla(), etc.).
   *
   * @type {RegExp}
   * @see {@link https://developer.mozilla.org/en-US/docs/Web/CSS/color_value}
   */
  const colorRegex = /^(#([0-9a-fA-F]{3}){1,2}|(rgb|hsl|hwb|lab|lch|oklab|oklch)a?\((-?\d+%?,\s*){2,3}-?\d*%?\))$/;

  /**
   * An array containing keywords for various colors.
   *
   * @type {string[]}
   */
  const colorKeywords = ["aliceblue", "antiquewhite", "aqua", "aquamarine", "azure", "beige", "bisque", "black", "blanchedalmond", "blue", "blueviolet", "brown", "burlywood", "cadetblue", "chartreuse", "chocolate", "coral", "cornflowerblue", "cornsilk", "crimson", "cyan", "darkblue", "darkcyan", "darkgoldenrod", "darkgray", "darkgreen", "darkgrey", "darkkhaki", "darkmagenta", "darkolivegreen", "darkorange", "darkorchid", "darkred", "darksalmon", "darkseagreen", "darkslateblue", "darkslategray", "darkslategrey", "darkturquoise", "darkviolet", "deeppink", "deepskyblue", "dimgray", "dimgrey", "dodgerblue", "firebrick", "floralwhite", "forestgreen", "fuchsia", "gainsboro", "ghostwhite", "gold", "goldenrod", "gray", "green", "greenyellow", "grey", "honeydew", "hotpink", "indianred", "indigo", "ivory", "khaki", "lavender", "lavenderblush", "lawngreen", "lemonchiffon", "lightblue", "lightcoral", "lightcyan", "lightgoldenrodyellow", "lightgray", "lightgreen", "lightgrey", "lightpink", "lightsalmon", "lightseagreen", "lightskyblue", "lightslategray", "lightslategrey", "lightsteelblue", "lightyellow", "lime", "limegreen", "linen", "magenta", "maroon", "mediumaquamarine", "mediumblue", "mediumorchid", "mediumpurple", "mediumseagreen", "mediumslateblue", "mediumspringgreen", "mediumturquoise", "mediumvioletred", "midnightblue", "mintcream", "mistyrose", "moccasin", "navajowhite", "navy", "oldlace", "olive", "olivedrab", "orange", "orangered", "orchid", "palegoldenrod", "palegreen", "paleturquoise", "palevioletred", "papayawhip", "peachpuff", "peru", "pink", "plum", "powderblue", "purple", "rebeccapurple", "red", "rosybrown", "royalblue", "saddlebrown", "salmon", "sandybrown", "seagreen", "seashell", "sienna", "silver", "skyblue", "slateblue", "slategray", "slategrey", "snow", "springgreen", "steelblue", "tan", "teal", "thistle", "tomato", "turquoise", "violet", "wheat", "white", "whitesmoke", "yellow", "yellowgreen"];

  /**
   * Array of CSS color method names.
   *
   * @type {Array<string>}
   */
  const cssColorMethods = [
    "color-adjust",
    "color-contrast",
    "color-gamut",
    "color-grayscale",
    "color-invert",
    "color-mix",
    "color-profile",
    "color-rendering",
    "color-saturation",
    "color-scheme",
    "color-stop",
    "color-temperature",
    "color",
    "color-interpolation"
  ];


  /**
   * Converts a component to its hexadecimal representation.
   *
   * @param {number} c - The component value to convert.
   * @return {string} - The hexadecimal representation of the component.
   */
  function componentToHex(c) {
    const hex = c.toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  }

  /**
   * Retrieves the red, green, and blue components from a hexadecimal color code.
   *
   * @param {string} hex - The hexadecimal color code.
   * @returns {Array} An array containing the red, green, and blue components of the color.
   */
  function getRgbComponentsFromHex(hex) {
    hex = hex.replace(/#/g, '');
    return [hex.substr(0, 2), hex.substr(2, 2), hex.substr(4, 2)];
  }

  /**
   * Extracts the RGB components from the given RGB color string.
   *
   * @param {string} rgb - The RGB color string in the format "rgb(r, g, b)" or "rgba(r, g, b)".
   * @return {Array<string>} - The array containing the RGB components [r, g, b].
   */
  function getRgbComponentsFromRgb(rgb) {
    rgb = rgb.replace(/rgba?\(/, '').replace(')', '');
    return rgb.split(', ');
  }

  /**
   * Converts an RGB color (string) value to a hexadecimal representation.
   *
   * @param {string} rgb - The RGB color value to convert. It should be in the format "rgb(r, g, b)".
   * @returns {string} The hexadecimal representation of the given RGB color.
   */
  function rgbToHex(rgb) {
    const rgbArr = getRgbComponentsFromRgb(rgb);
    return '#' + componentToHex(parseInt(rgbArr[0])) + componentToHex(parseInt(rgbArr[1])) + componentToHex(parseInt(rgbArr[2]));
  }


  /**
   * Checks if the specified element and its ancestors are visible.
   * An element is considered visible if its CSS display property is not 'none' or 'hidden',
   * and its visibility CSS property is not 'hidden'.
   *
   * @param {Element} el - The element to check visibility for.
   * @returns {boolean} - True if the element and its ancestors are visible, false otherwise.
   */
  function isVisible(el) {
    if (['none', 'hidden'].includes(getComputedStyle(el).display) || getComputedStyle(el).visibility === 'hidden') {
      return false;
    }
    let parent = el.parentElement;
    while (parent !== null) {
      if (['none', 'hidden'].includes(getComputedStyle(parent).display) || getComputedStyle(parent).visibility === 'hidden') {
        return false;
      }
      parent = parent.parentElement;
    }
    return true;
  }




  /**
   * Extracts extra colors from given elements.
   *
   * @return {Array} - The extra colors extracted from the given elements.
   *
   *     [
   *       {
   *         element: 'p' | 'div', ...
   *         visible: true | false,
   *         bgColor: {
   *           hex: '#0098db',
   *           rgba: '#0098db',
   *           sum: 56789 // for sorting
   *         },
   *         color: {
   *           hex: '#0098db',
   *           rgba: '#0098db',
   *           sum: 678
   *         }
   *       },
   *       ...
   *     ]
   *
   */
  function extractColors(){
    const ret = [];
    for (const ele of elements) {
      extractColorsFromGivenElement(ele, ret);
    }
    return ret;
  }

  /**
   * Calculates the sum of the weighted RGB components of a given hexadecimal color.
   *
   * @param {string} hex - The hexadecimal color code.
   * @return {number} - The sum of the weighted RGB components.
   */
  function rgbaSum(hex){
    const [r, g, b] = getRgbComponentsFromHex(hex);
    return (0.3 * parseInt(r, 16) / 255) + (0.59 * parseInt(g, 16) / 255) + (0.11 * parseInt(b, 16) / 255);
  }

  /**
   * Extracts colors and visibility from elements matching the given selector.
   *
   * @param {string} element - The CSS selector for the elements to extract colors from.
   * @param {Array} ret - The array to store the extracted colors and visibility.
   * @returns {Array} - The modified ret array containing the extracted colors and visibility.
   */
  function extractColorsFromGivenElement(element, ret) {
    document
      .querySelectorAll(element)
      .forEach(el => {
        const style = getComputedStyle(el);
        const colorRgba = style.color;
        const colorHex = rgbToHex(colorRgba);
        const bgColorRgba = style.backgroundColor;
        const bgColorHex = rgbToHex(bgColorRgba);
        const visible = isVisible(el);

        const item = {
          element: element+'',
          visible: visible,
          color: {
            hex: colorHex,
            rgba: colorRgba,
            sum: rgbaSum(colorHex)
          },
          bgColor: {
            hex: bgColorHex,
            rgba: bgColorRgba,
            sum: rgbaSum(bgColorHex)
          }
        };
        if (!arrayContainsObject(ret, item, isEqual)) {
          ret.push(item);
        }
    });
    return ret;
  }

  /**
   * Determines whether two objects are equal based on their element, visibility, and color.
   *
   * @param {object} o1 - The first object to compare.
   * @param {object} o2 - The second object to compare.
   * @returns {boolean} - True if the objects are equal, false otherwise.
   */
  function isEqual(o1, o2) {
    return o1.element === o2.element
      && o1.visible === o2.visible
      && o1.color.rgba === o2.color.rgba
      && o1.bgColor.rgba === o2.bgColor.rgba;
  }

  /**
   * Checks if an object is present in an array using a custom comparator function.
   *
   * @param {Array} arr - The array to search.
   * @param {Object} obj - The object to check for presence.
   * @param {Function} comparator - The custom comparator function to use for comparison.
   * @return {boolean} - True if the object is found in the array, false otherwise.
   */
  function arrayContainsObject(arr, obj, comparator) {
    return arr.some(item => comparator(item, obj));
  }




  /**
   * Checks if the given value is a valid css color.
   *
   * @param {string} value - The value to be checked.
   * @return {boolean} - True if the value is a valid color, false otherwise.
   */
  function isColor(value) {
    if (cssColorMethods.includes(value)) return true;
    if (colorKeywords.includes(value)) return true;
    return colorRegex.test(value.trim());
  }

  /**
   * Retrieves all CSS custom properties that have color values from the loaded style sheets.
   *
   * @returns {Array<Object>} An array of objects containing the rule selector, property name, and property value.
   */
  function getCSSCustomProperties() {
    const ret = [];
    for (const styleSheet of document.styleSheets) {
      if (styleSheet.href && styleSheet.href.startsWith(window.location.origin)) {
        for (const rule of styleSheet.cssRules) {
          if (rule instanceof CSSStyleRule) {
            const style = rule.style;
            for (let i = 0; i < style.length; i++) {
              const propertyName = style[i];
              if (propertyName.startsWith('--')) {
                let propertyValue = style.getPropertyValue(propertyName);
                if (isColor(propertyValue)) {
                  ret.push({
                    rule: rule.selectorText,
                    propertyName,
                    propertyValue
                  });
                }
              }
            }
          }
        }
      }
    }
    return ret;
  }

  /**
   * Retrieves all CSS custom properties as a nested map.
   *
   * @returns {Object} - Nested map of CSS custom properties.
   */
  function getCSSCustomPropertiesAsMap() {
    const properties = getCSSCustomProperties();
    const map = {};
    properties.forEach(property => {
      const { propertyName, propertyValue, rule } = property;
      if (!map[rule]) {
        map[rule] = {};
      }
      map[rule][propertyName] = propertyValue;
    });
    return map;
  }



  
  const ret = {
    cssCustomProperties: getCSSCustomPropertiesAsMap(),
    extractedColors: extractColors().sort((a, b) => (a.bgColor.sum > b.bgColor.sum) ? 1 : -1),
  };
  if (window.location.href.includes('debug=1')) {
    console.log(ret);
  }
  return ret;
};
